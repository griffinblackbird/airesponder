name: Deploy to GitHub Container Registry

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect project type
        id: detect-project-type
        run: |
          if [ -f "pyproject.toml" ]; then
            echo "PROJECT_TYPE=python" >> $GITHUB_ENV
          elif [ -f "package.json" ]; then
            echo "PROJECT_TYPE=javascript" >> $GITHUB_ENV
          else
            echo "PROJECT_TYPE=unknown" >> $GITHUB_ENV
          fi

      - name: Set up Python (if needed)
        if: env.PROJECT_TYPE == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies (Python)
        if: env.PROJECT_TYPE == 'python'
        run: |
          python -m pip install uv
          python -m uv venv .venv
          source .venv/bin/activate
          uv pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Node.js (if needed)
        if: env.PROJECT_TYPE == 'javascript'
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'

      - name: Install dependencies (JavaScript)
        if: env.PROJECT_TYPE == 'javascript'
        run: npm install

      - name: Build Docker image
        run: docker build -t ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }} .

      - name: Push Docker image
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ github.repository }}:latest
          docker push ${{ env.REGISTRY }}/${{ github.repository }}:latest